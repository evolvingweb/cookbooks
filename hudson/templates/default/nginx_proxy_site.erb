# Generated by Chef for <%= node[:fqdn] %>
# http://sleeplesscoding.blogspot.com/2010/07/hudson-ci-behind-nginx-reverse-proxy.html

upstream hudson {
  server localhost:<%= node[:hudson][:proxy][:local_port] %>;
}

server {
  listen 80;
  rewrite ^ https://<%= node[:fqdn] %>$request_uri? permanent;
}

server {
  listen 443;

  access_log <%= node[:nginx][:log_dir] %>/hudson.access.log;

  ssl                       on; 
  ssl_certificate           /etc/ssl/<%= node[:domain] %>/<%= node[:hudson][:proxy][:cert_file] %>;
  ssl_certificate_key       /etc/ssl/<%= node[:domain] %>/<%= node[:hudson][:proxy][:key_file] %>;
  ssl_session_timeout       5m; 
  ssl_protocols             SSLv2 SSLv3 TLSv1;
  ssl_ciphers               ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP;
  ssl_prefer_server_ciphers on; 

  # force host with domain name
  if ($host !~* <%= node[:domain] %>) {
    rewrite ^ https://<%= node[:fqdn] %>$request_uri? permanent;
    break;
  }

  location / {
    proxy_set_header    X-Real-IP $remote_addr;
    proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header    X-Forwarded-Proto https;
    proxy_set_header    Host $http_host;
    proxy_next_upstream error;
    proxy_pass          <%= node[:hudson][:proxy][:local_scheme] %>://hudson;
    proxy_redirect      http://<%= node[:fqdn] %>/ https://<%= node[:fqdn] %>/;
  }
}
